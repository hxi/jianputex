%       jianpu.sty      coded by YIN Dian
%       Typeset Chinese Numbered Musical Notation.
%       Hist:   080124  Start coding.
%               080125  Continue coding.
%               080201  Continue coding.
%               080203  Continue coding.
\NeedsTeXFormat{LaTeX2e}[1996/12/01]
\def\fileversion{0.1}
\def\filedate{2008/02/01}
\ProvidesPackage{jianpu}[\filedate\space\fileversion]

\ifx\eTeXrevision\@undefined
  \PackageError{jianpu}{eTeX required to use this package}{}
\fi

% allocation
\newif\ifjpu@result
\newbox\jpu@tmpbox
\newcount\jpu@notelen
\newcount\jpu@lastnotelen
\newcount\jpu@tabindex

% parameter setting
\def\jpu@p@notewidth{1em}
\def\jpu@p@font{\sffamily}

% \futurenonspacelet
\def\@BTcs{}
\let\nexttoken\relax
\let\next\relax
\def\futurenonspacelet#1{\def\@BTcs{#1}%
   \afterassignment\@BTfnslone\let\nexttoken= }
\def\@BTfnslone{\expandafter\futurelet\@BTcs\@BTfnsltwo}
\def\@BTfnsltwo{\expandafter\ifx\@BTcs\@sptoken\let\next=\@BTfnslthree
   \else\let\next=\nexttoken\fi \next}
\def\@BTfnslthree{\afterassignment\@BTfnslone\let\next= }

% some basic macros
\def\jpu@firsttok#1#2\@nil{#1}
\def\jpu@testifnum#1{%
  \jpu@resultfalse
  \def\jpu@tmpmacro{#1}%
  \unless\ifx\jpu@tmpmacro\empty
    \expandafter\def\expandafter\jpu@tmpmacr@\expandafter{\jpu@firsttok #1\@nil}%
    \ifx\jpu@tmpmacro\jpu@tmpmacr@
      \if\noexpand #10 \jpu@resulttrue\else
      \if\noexpand #11 \jpu@resulttrue\else
      \if\noexpand #12 \jpu@resulttrue\else
      \if\noexpand #13 \jpu@resulttrue\else
      \if\noexpand #14 \jpu@resulttrue\else
      \if\noexpand #15 \jpu@resulttrue\else
      \if\noexpand #16 \jpu@resulttrue\else
      \if\noexpand #17 \jpu@resulttrue\else
      \if\noexpand #18 \jpu@resulttrue\else
      \if\noexpand #19 \jpu@resulttrue
      \fi\fi\fi\fi\fi\fi\fi\fi\fi\fi
    \fi
  \fi
}

% jpuline part
\def\jpu@state{0}
\def\melody{\jpu@melody}
\def\jpu@melody{%
  \def\jpu@line{}%
  \jpu@lastnotelen=0
  \jpu@notelen=0
  \jpu@tabindex=0
  \let\jpu@notename\empty
  \def\jpu@noteextr{}%
  \futurenonspacelet\jpu@nextchar\jpu@melody@iter
}

\def\jpu@melody@iter{%
  \def\jpu@return{\futurenonspacelet\jpu@nextchar\jpu@melody@iter}%
  \def\jpu@iternext{\afterassignment\jpu@return\let\jpu@nextchar}%
  \ifx\jpu@nextchar\bgroup % next char is {
    \let\jpu@iternext\jpu@melody@addnextgroup
  \else
    \jpu@testifnum\jpu@nextchar
    \ifjpu@result       % next char is a number
      \let\jpu@iternext\jpu@melody@numbernext
    \else
      \ifx\jpu@nextchar|% bar line
        \let\jpu@iternext\jpu@melody@bar
      \else
        \ifx\jpu@nextchar[% halve note length
          \jpu@lastnotelen=\jpu@notelen
          \advance\jpu@notelen 1
        \else
          \ifx\jpu@nextchar]% double note length
            \jpu@lastnotelen=\jpu@notelen
            \advance\jpu@notelen-1
            \ifnum\jpu@notelen<0
              \PackageError{jianpu}{Note length cannot double now.}{}
            \fi
          \else
            \ifx\jpu@nextchar(% begin tie
              \let\jpu@iternext\jpu@melody@begintie
            \else
              \ifx\jpu@nextchar)% end tie
                \let\jpu@iternext\jpu@melody@endtie
              \else
                \ifx\jpu@nextchar\\% end of \melody line
                  \let\jpu@iternext\jpu@endmelody
                \else
                  \let\jpu@iternext\jpu@melody@addnextchar
                \fi
              \fi
            \fi
          \fi
        \fi
      \fi
    \fi
  \fi
  \jpu@iternext
}

\def\jpu@melody@addnextgroup#1{%
  \expandafter\def\expandafter\jpu@line\expandafter{\jpu@line {#1}}%
  \jpu@return
}

\def\jpu@melody@addnextchar#1{%
  \expandafter\def\expandafter\jpu@line\expandafter{\jpu@line #1}%
  \jpu@return
}

\def\jpu@melody@numbernext#1{% #1: number, i.e. the musical note
  \expandafter\def\expandafter\jpu@line\expandafter{\jpu@line &}%
  \unless\ifx\jpu@notename\empty
    \jpu@melody@flushnote
  \fi
  \let\jpu@notename=#1%
  \def\jpu@noteextr{}%
  \futurenonspacelet\jpu@nextchar\jpu@melody@numberextra
}

\def\jpu@melody@numberextra{% ^ _ - . etc
  \let\jpu@melody@numberextranext\jpu@return
  \ifx\jpu@nextchar^%
    \let\jpu@melody@numberextranext\jpu@melody@numberextreat
  \else
    \ifx\jpu@nextchar_%
      \let\jpu@melody@numberextranext\jpu@melody@numberextreat
    \else
      \ifx\jpu@nextchar-%
        \let\jpu@melody@numberextranext\jpu@melody@numberextreat
      \else
        \ifx\jpu@nextchar.%
          \let\jpu@melody@numberextranext\jpu@melody@numberextreat
        \fi
      \fi
    \fi
  \fi
  \jpu@melody@numberextranext
}

\def\jpu@melody@numberextreat{%
  \afterassignment\jpu@melody@numberextra\let\jpu@nextchar
}

\def\jpu@melody@flushnote{%
}

\def\jpu@melody@begintie({%
  \jpu@return
}

\def\jpu@melody@endtie){%
  \jpu@return
}

\def\jpu@melody@bar|{%
  \jpu@return
}

\def\jpu@endmelody\\{%
  \message{\meaning\jpu@line}%
}


\endinput
